{% extends "base.html" %} 
{% block title %}Tokens{% endblock %} 
{% block content %}
<h2 class="text-xl font-semibold mb-4">üí∞ Tokeniza√ß√£o de Obras</h2>

<!-- Emitir Token -->
<h3 class="font-semibold">1. Emitir Token</h3>

<!-- Dropdown para selecionar obra -->
<select id="mintArtworkId" class="w-full border p-2 mt-2">
  <option value="" disabled selected>Escolha uma obra</option>
</select>

<!-- Campo para o pre√ßo do token -->
<input
  type="number"
  id="priceTokens"
  placeholder="Pre√ßo do Token (em tokens)"
  class="w-full border p-2 mt-2"
/>

<!-- Owner ID preenchido automaticamente -->
<input
  type="hidden"
  id="mintOwnerId"
  class="w-full border p-2 mt-2"
/>

<button
  onclick="mintToken()"
  class="bg-teal-700 text-white px-4 py-2 rounded mt-2"
>
  Emitir Token
</button>

<pre id="mintResult" class="bg-gray-100 p-2 rounded mt-2"></pre>

<hr class="my-6" />

<!-- Consultar Token -->
<h3 class="font-semibold">2. Consultar Token</h3>
<input
  type="number"
  id="queryTokenId"
  placeholder="Token ID"
  class="w-full border p-2 mt-2"
/>
<button
  onclick="queryToken()"
  class="bg-gray-700 text-white px-4 py-2 rounded mt-2"
>
  Consultar Token
</button>
<pre id="queryResult" class="bg-gray-100 p-2 rounded mt-2"></pre>

<script>
  async function loadArtworks() {
    const authorId = localStorage.getItem("user_id");
    console.log("ID do autor carregado do localStorage:", authorId);

    if (!authorId) {
      alert("ID do usu√°rio n√£o encontrado.");
      return;
    }

    document.getElementById("mintOwnerId").value = authorId;

    try {
      const resp = await axios.get(`/artworks/author/${authorId}`);
      const artworks = resp.data;

      const select = document.getElementById("mintArtworkId");
      // Limpa op√ß√µes antigas
      select.innerHTML = '<option value="" disabled selected>Escolha uma obra</option>';

      artworks.forEach(artwork => {
        const option = document.createElement("option");
        option.value = artwork.id;
        option.textContent = `${artwork.title} (${artwork.id})`;
        select.appendChild(option);
      });
    } catch (err) {
      console.error("Erro ao carregar obras:", err);
      alert("Erro ao carregar obras.");
    }
  }

  async function mintToken() {
    const artworkId = parseInt(document.getElementById("mintArtworkId").value);
    const ownerId = parseInt(document.getElementById("mintOwnerId").value);
    const priceTokens = parseInt(document.getElementById("priceTokens").value);

    if (!artworkId || !ownerId || !priceTokens) {
      document.getElementById("mintResult").textContent = "Por favor, preencha todos os campos.";
      return;
    }

    try {
      const resp = await axios.post("/tokens/mint", {
        artwork_id: artworkId,
        price_tokens: priceTokens,
        owner_id: ownerId,
      });
      document.getElementById("mintResult").textContent = JSON.stringify(resp.data, null, 2);
    } catch (err) {
      document.getElementById("mintResult").textContent =
        err.response?.data?.detail || "Erro ao emitir token.";
    }
  }

  async function queryToken() {
    const tokenId = document.getElementById("queryTokenId").value;
    try {
      const resp = await axios.get(`/tokens/${tokenId}`);
      document.getElementById("queryResult").textContent = JSON.stringify(resp.data, null, 2);
    } catch (err) {
      document.getElementById("queryResult").textContent =
        err.response?.data?.detail || "Erro ao consultar token.";
    }
  }

  window.onload = async function () {
    await loadArtworks();
  };
</script>
{% endblock %}
